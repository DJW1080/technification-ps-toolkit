name: Test

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install test dependencies
      shell: pwsh
      run: |
        Install-Module PSScriptAnalyzer -Repository PSGallery -Force -Scope CurrentUser -Confirm:$false
        Install-Module Pester -Repository PSGallery -Force -Scope CurrentUser -Confirm:$false

        Get-Module PSScriptAnalyzer -ListAvailable | Select-Object Name,Version | Sort-Object Version -Descending | Select-Object -First 1
        Get-Module Pester -ListAvailable | Select-Object Name,Version | Sort-Object Version -Descending | Select-Object -First 1

    - name: Run ScriptAnalyzer
      shell: pwsh
      run: |
        $results = Invoke-ScriptAnalyzer -Path "$env:GITHUB_WORKSPACE/src" -Recurse -Severity Warning,Error

        if ($results) {
          $results | Format-Table
          throw "PSScriptAnalyzer found issues."
        }

    - name: Run Pester tests
      shell: pwsh
      run: |
        if (-not (Test-Path "$env:GITHUB_WORKSPACE/tests")) {
          throw "Tests folder not found."
        }

        Invoke-Pester -Path "$env:GITHUB_WORKSPACE/tests" -CI
